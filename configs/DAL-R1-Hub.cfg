!===========================
! DAL-R1 (HUB - Dallas) - CSR1000v
! Enterprise Hub-and-Spoke IPSec VPN Lab
!===========================
hostname DAL-R1
enable secret Cisco123!
username admin privilege 15 secret Admin123!
service password-encryption
!
! IMPROVEMENT: Loopback for OSPF Router-ID Stability
interface Loopback0
 description OSPF Router-ID Interface
 ip address 1.1.1.1 255.255.255.255
 no shutdown
!
! IMPROVEMENT: Enhanced IKEv2 with Stronger Crypto
crypto ikev2 proposal IKEv2_PROPOSAL
 encryption aes-gcm-256
 integrity sha384
 group 16
!
crypto ikev2 policy IKEv2_POLICY
 proposal IKEv2_PROPOSAL
!
crypto ikev2 keyring IKEv2_KEYRING
 peer LAX
  address 203.0.113.25
  pre-shared-key [REPLACE_WITH_LAX_PSK]
 peer DEN  
  address 192.0.2.100
  pre-shared-key [REPLACE_WITH_DEN_PSK]
 peer ATL
  address 198.18.1.55
  pre-shared-key [REPLACE_WITH_ATL_PSK]
 peer WDC
  address 203.11.200.44
  pre-shared-key [REPLACE_WITH_WDC_PSK]
!
! IMPROVEMENT: DPD Configuration for Better Reliability
crypto ikev2 profile IKEv2_PROFILE
 match identity remote address 203.0.113.25 255.255.255.255
 match identity remote address 192.0.2.100 255.255.255.255  
 match identity remote address 198.18.1.55 255.255.255.255
 match identity remote address 203.11.200.44 255.255.255.255
 authentication remote pre-share
 authentication local pre-share
 keyring local IKEv2_KEYRING
 dpd 10 3 periodic
!
! IMPROVEMENT: Enhanced IPSec with AES-GCM
crypto ipsec transform-set VPN_SET esp-gcm 256
 mode tunnel
!
crypto ipsec profile VPN_PROFILE
 set transform-set VPN_SET
 set pfs group16
 set ikev2-profile IKEv2_PROFILE
!
! WAN Interfaces
interface GigabitEthernet1
 description Primary WAN to ISP1
 ip address 198.51.100.10 255.255.255.0
 ip nat outside
 no shutdown
!
interface GigabitEthernet2
 description Backup WAN to ISP2
 ip address 203.0.114.10 255.255.255.0
 ip nat outside
 no shutdown
!
! LAN Interface
interface GigabitEthernet3
 description LAN Interface
 ip address 10.1.0.1 255.255.0.0
 ip nat inside
 no shutdown
!
! PRIMARY VPN Tunnels (via ISP1)
interface Tunnel10
 description Primary VPN to LAX
 ip address 172.16.0.1 255.255.255.252
 tunnel source GigabitEthernet1
 tunnel destination 203.0.113.25
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 no shutdown
!
interface Tunnel20
 description Primary VPN to DEN
 ip address 172.16.0.5 255.255.255.252
 tunnel source GigabitEthernet1
 tunnel destination 192.0.2.100
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 no shutdown
!
interface Tunnel30
 description Primary VPN to ATL
 ip address 172.16.0.9 255.255.255.252
 tunnel source GigabitEthernet1
 tunnel destination 198.18.1.55
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 no shutdown
!
interface Tunnel40
 description Primary VPN to WDC
 ip address 172.16.0.13 255.255.255.252
 tunnel source GigabitEthernet1
 tunnel destination 203.11.200.44
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 no shutdown
!
! BACKUP VPN Tunnels (via ISP2)
interface Tunnel11
 description Backup VPN to LAX via ISP2
 ip address 172.16.1.1 255.255.255.252
 tunnel source GigabitEthernet2
 tunnel destination 203.0.113.25
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 shutdown
!
interface Tunnel21
 description Backup VPN to DEN via ISP2
 ip address 172.16.1.5 255.255.255.252
 tunnel source GigabitEthernet2
 tunnel destination 192.0.2.100
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 shutdown
!
interface Tunnel31
 description Backup VPN to ATL via ISP2
 ip address 172.16.1.9 255.255.255.252
 tunnel source GigabitEthernet2
 tunnel destination 198.18.1.55
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 shutdown
!
interface Tunnel41
 description Backup VPN to WDC via ISP2
 ip address 172.16.1.13 255.255.255.252
 tunnel source GigabitEthernet2
 tunnel destination 203.11.200.44
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VPN_PROFILE
 keepalive 30 3
 bandwidth 100000
 shutdown
!
! QoS for VPN Traffic
class-map match-all VOICE_TRAFFIC
 match dscp ef
!
class-map match-all VIDEO_TRAFFIC  
 match dscp af41
!
class-map match-all CRITICAL_DATA
 match dscp af31
!
policy-map VPN_QOS_POLICY
 class VOICE_TRAFFIC
  priority percent 20
 class VIDEO_TRAFFIC
  bandwidth percent 30
 class CRITICAL_DATA
  bandwidth percent 25
 class class-default
  fair-queue
!
! Apply QoS to tunnel interfaces
interface Tunnel10
 service-policy output VPN_QOS_POLICY
interface Tunnel20
 service-policy output VPN_QOS_POLICY
interface Tunnel30
 service-policy output VPN_QOS_POLICY
interface Tunnel40
 service-policy output VPN_QOS_POLICY
!
! IMPROVEMENT: OSPF with Loopback Router-ID for Stability
router ospf 1
 router-id 1.1.1.1
 network 1.1.1.1 0.0.0.0 area 0
 network 10.1.0.0 0.0.255.255 area 0
 network 172.16.0.0 0.0.255.255 area 0
 network 172.16.1.0 0.0.255.255 area 0
 default-information originate always
!
! NAT - Allow internal networks internet access
ip access-list extended NAT_ACL
 deny ip 10.0.0.0 0.255.255.255 10.0.0.0 0.255.255.255
 permit ip 10.0.0.0 0.255.255.255 any
!
ip nat inside source list NAT_ACL interface GigabitEthernet1 overload
ip nat inside source list NAT_ACL interface GigabitEthernet2 overload
!
! SLA Tracking for Dynamic Failover
ip sla 1
 icmp-echo 8.8.8.8 source-interface GigabitEthernet1
 frequency 10
 timeout 5000
 threshold 3000
!
ip sla 2  
 icmp-echo 1.1.1.1 source-interface GigabitEthernet1
 frequency 10
 timeout 5000
 threshold 3000
!
ip sla schedule 1 life forever start-time now
ip sla schedule 2 life forever start-time now
!
track 1 ip sla 1 reachability
track 2 ip sla 2 reachability
track 1
